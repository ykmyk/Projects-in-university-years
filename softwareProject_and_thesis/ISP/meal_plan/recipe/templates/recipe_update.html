{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Recipe | Meal Plan{% endblock %}
{% block active_recipe_list %}active{% endblock %}

{% block contents %}
<div class="container my-div-style">
    <h1 class="text-center mb-4">Edit Recipe</h1>

    <form method="POST">
        {% csrf_token %}
        <div class="mb-3">{{ form.name.label_tag }} {{ form.name }}</div>

        <div class="row g-2 mb-3">
            <div class="col-6">{{ form.servings.label_tag }} {{ form.servings }}</div>
            <div class="col-6">{{ form.duration_minutes.label_tag }} {{ form.duration_minutes }}</div>
        </div>

        <div class="form-check mb-4">
            {{ form.is_public }} {{ form.is_public.label_tag }}
        </div>

        <hr>
    <h5>Ingredients</h5>
        <div id="ingredients-container">
            {% for ing in object.ingredients %}
            <div class="row g-2 mb-2 ingredient-row">
                <div class="col-6">
                <input name="ing-name[]" value="{{ ing.name }}" class="form-control" placeholder="Ingredient">
                </div>
                <div class="col-3">
                <input name="ing-qty[]"  value="{{ ing.quantity }}" class="form-control" placeholder="Qty">
                </div>
                <div class="col-3">
                <select name="ing-unit[]" class="form-select">
                    <option value="">â€”</option>
                    {% for unit in unit_choices %}
                    <option value="{{ unit }}" {% if ing.unit == unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                </select>
                </div>
            </div>
            {% empty %}
            <div class="row g-2 mb-2 ingredient-row">
                <div class="col-6"><input name="ing-name[]" class="form-control" placeholder="Ingredient"></div>
                <div class="col-3"><input name="ing-qty[]"  class="form-control" placeholder="Qty"></div>
                <div class="col-3">
                <select name="ing-unit[]" class="form-select">
                    <option value="">â€”</option>
                    {% for unit in unit_choices %}<option value="{{ unit }}">{{ unit }}</option>{% endfor %}
                </select>
                </div>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-ingredient">Add Ingredient</button>
    <hr>
    <h5>Cooking Steps</h5>

        {# 1) Hidden field that is actually submitted #}
        <input type="hidden" name="steps_text" id="steps_text_joined">

        {# 2) A hidden source <textarea> with saved text so JS can prefill rows #}
        <textarea id="steps_text_source" class="d-none">{{ form.instance.steps_text }}</textarea>

        {# 3) Same multi-row UI as create #}
        <div id="steps-container">
            <div class="row g-2 mb-2 step-row align-items-stretch">
                <div class="col-md-1 d-flex align-items-center justify-content-end">
                <span class="step-index">1.</span>
                </div>

                <div class="col-md-10">
                <textarea class="form-control control-42 step-text" rows="2"
                            placeholder="Describe step 1..."></textarea>
                </div>

                <div class="col-md-1 d-grid">
                <button type="button"
                        class="btn btn-outline-secondary btn-icon remove-step h-100"
                        title="Remove step">Ã—</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-step">
            Add step
        </button>

        <div class="mt-4 text-end">
                <a href="{% url 'recipe:recipe_list' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
</div>

<script>
    // ===== INGREDIENTS (same as create) =====
    const ingContainer = document.getElementById('ingredients-container');
    const addIngBtn    = document.getElementById('add-ingredient');

    function addIngredientRow() {
        const first = ingContainer.querySelector('.ingredient-row');
        const clone = first.cloneNode(true);
        clone.querySelectorAll('input').forEach(i => i.value = '');
        ingContainer.appendChild(clone);
    }
    addIngBtn.addEventListener('click', addIngredientRow);

    ingContainer.addEventListener('click', (e) => {
        if (!e.target.classList.contains('remove-ingredient')) return;
        const rows = ingContainer.querySelectorAll('.ingredient-row');
        if (rows.length === 1) { rows[0].querySelectorAll('input').forEach(i => i.value=''); return; }
        e.target.closest('.ingredient-row').remove();
    });

    // ===== COOKING STEPS (same as create, plus prefill) =====
    const stepsContainer = document.getElementById('steps-container');
    const addStepBtn     = document.getElementById('add-step');
    const stepsHidden    = document.getElementById('steps_text_joined');
    const stepsSource    = document.getElementById('steps_text_source');
    const formEl         = document.querySelector('form');

    function renumberSteps() {
        const rows = stepsContainer.querySelectorAll('.step-row');
        rows.forEach((row, i) => {
        const n = i + 1;
        row.querySelector('.step-index').textContent = n + '.';
        row.querySelector('.step-text').placeholder  = 'Describe step ' + n + '...';
        });
    }

    function addStepRow() {
        const first = stepsContainer.querySelector('.step-row');
        const clone = first.cloneNode(true);
        clone.querySelector('.step-text').value = '';
        stepsContainer.appendChild(clone);
        renumberSteps();
    }
    addStepBtn.addEventListener('click', addStepRow);

    stepsContainer.addEventListener('click', (e) => {
        if (!e.target.classList.contains('remove-step')) return;
        const rows = stepsContainer.querySelectorAll('.step-row');
        if (rows.length === 1) { rows[0].querySelector('.step-text').value=''; return; }
        e.target.closest('.step-row').remove();
        renumberSteps();
    });

    // Join textareas -> single field for backend
    formEl.addEventListener('submit', () => {
        const lines = [...stepsContainer.querySelectorAll('.step-text')]
        .map(t => t.value.trim()).filter(Boolean);
        stepsHidden.value = lines.join('\n');
    });

    // Prefill from server for UPDATE
    (function initStepsFromSaved() {
        const saved = (stepsSource && stepsSource.value) ? stepsSource.value.split(/\r?\n/) : [];
        if (saved.length) {
        const first = stepsContainer.querySelector('.step-row');
        first.querySelector('.step-text').value = saved[0];
        for (let i = 1; i < saved.length; i++) {
            addStepRow();
            stepsContainer.querySelectorAll('.step-text')[i].value = saved[i];
        }
        }
        renumberSteps();
    })();
    </script>
{% endblock %}